<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de V√≠deo via WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        #videoFeed {
            display: block;
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            background-color: #000;
            margin: 0 auto 20px auto;
            border-radius: 4px;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .controls label {
            margin-right: 10px;
            font-weight: bold;
        }

        .controls input[type="number"] {
            width: 60px;
            padding: 8px;
            margin-right: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .controls button {
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .controls button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .controls button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .controls button.stop {
            background-color: #e74c3c;
        }

        .controls button.stop:hover:not(:disabled) {
            background-color: #c0392b;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        #status.error {
            background-color: #fdf2f2;
            border-left-color: #e74c3c;
            color: #721c24;
        }

        #status.success {
            background-color: #f0fff4;
            border-left-color: #27ae60;
            color: #155724;
        }

        .info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4fd;
            border-radius: 4px;
            font-size: 14px;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìπ Visualizador de C√¢mera</h1>

        <img id="videoFeed" alt="Feed da C√¢mera" style="display: none;">
        <div id="loadingMessage" class="loading">Conectando ao WebSocket...</div>

        <div class="controls">
            <label for="cameraId">ID da C√¢mera:</label>
            <input type="number" id="cameraId" value="0" min="0" max="10">
            <button id="startButton" disabled>‚ñ∂Ô∏è Iniciar C√¢mera</button>
            <button id="stopButton" class="stop" disabled>‚èπÔ∏è Parar C√¢mera</button>
        </div>

        <div id="status">Conectando ao WebSocket...</div>

        <div class="info">
            <strong>üí° Dicas:</strong><br>
            ‚Ä¢ Se a c√¢mera n√£o funcionar, tente IDs diferentes (0, 1, 2...)<br>
            ‚Ä¢ Certifique-se de que nenhum outro programa est√° usando a c√¢mera<br>
            ‚Ä¢ Esta vers√£o apenas mostra o v√≠deo, sem processamento de placas
        </div>
    </div>

    <script>
        const videoFeed = document.getElementById('videoFeed');
        const loadingMessage = document.getElementById('loadingMessage');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const cameraIdInput = document.getElementById('cameraId');
        const statusDiv = document.getElementById('status');

        const socketUrl = `ws://${window.location.hostname}:8000/ws/video-stream/`;
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function connectWebSocket() {
            updateStatus("Conectando ao WebSocket...");
            socket = new WebSocket(socketUrl);

            socket.onopen = function(e) {
                updateStatus("‚úÖ WebSocket conectado com sucesso!", 'success');
                startButton.disabled = false;
                reconnectAttempts = 0;
            };

            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === 'frame') {
                        // Mostrar v√≠deo
                        videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
                        if (videoFeed.style.display === 'none') {
                            videoFeed.style.display = 'block';
                            loadingMessage.style.display = 'none';
                        }

                    } else if (data.type === 'camera_started') {
                        updateStatus(`‚úÖ ${data.message}`, 'success');
                        startButton.disabled = true;
                        stopButton.disabled = false;

                    } else if (data.type === 'camera_stopped') {
                        updateStatus(`‚èπÔ∏è ${data.message}`);
                        startButton.disabled = false;
                        stopButton.disabled = true;
                        videoFeed.style.display = 'none';
                        loadingMessage.style.display = 'block';
                        loadingMessage.textContent = 'C√¢mera parada';

                    } else if (data.type === 'error') {
                        updateStatus(`‚ùå ${data.message}`, 'error');
                        startButton.disabled = false;
                        stopButton.disabled = true;

                    } else if (data.type === 'connection') {
                        updateStatus(`üîó ${data.message}`, 'success');
                    }

                } catch (e) {
                    console.error('Erro ao processar mensagem:', e);
                }
            };

            socket.onclose = function(event) {
                startButton.disabled = true;
                stopButton.disabled = true;
                videoFeed.style.display = 'none';
                loadingMessage.style.display = 'block';

                if (event.wasClean) {
                    updateStatus(`üîå Conex√£o fechada (c√≥digo: ${event.code})`);
                    loadingMessage.textContent = 'Desconectado';
                } else {
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        updateStatus(`‚ùå Conex√£o perdida. Tentativa ${reconnectAttempts}/${maxReconnectAttempts} em 3s...`, 'error');
                        loadingMessage.textContent = 'Reconectando...';
                        setTimeout(connectWebSocket, 3000);
                    } else {
                        updateStatus('‚ùå N√£o foi poss√≠vel reconectar. Recarregue a p√°gina.', 'error');
                        loadingMessage.textContent = 'Erro de conex√£o';
                    }
                }
            };

            socket.onerror = function(error) {
                updateStatus('üìõ Erro no WebSocket', 'error');
                console.error('WebSocket error:', error);
            };
        }

        startButton.onclick = function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const camId = parseInt(cameraIdInput.value, 10);
                const message = {
                    command: 'start_camera',
                    camera_id: camId
                };
                socket.send(JSON.stringify(message));
                updateStatus(`üìπ Tentando iniciar c√¢mera ${camId}...`);
                loadingMessage.style.display = 'block';
                loadingMessage.textContent = 'Iniciando c√¢mera...';
            } else {
                updateStatus("‚ùå WebSocket n√£o est√° conectado", 'error');
            }
        };

        stopButton.onclick = function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ command: 'stop_camera' }));
                updateStatus("‚èπÔ∏è Parando c√¢mera...");
            } else {
                updateStatus("‚ùå WebSocket n√£o est√° conectado", 'error');
            }
        };

        // Conectar automaticamente quando a p√°gina carregar
        connectWebSocket();

        // Limpar recursos ao sair da p√°gina
        window.addEventListener('beforeunload', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ command: 'stop_camera' }));
                socket.close();
            }
        });
    </script>
</body>
</html>